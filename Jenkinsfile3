pipeline {
  agent any

  environment {
    DISABLE_SPINNER = "TRUE"

    ACCUKNOX_ENDPOINT = "cspm.demo.accuknox.com"
    ACCUKNOX_LABEL = "AccuKnoxInfyPOC"
    ACCUKNOX_TOKEN = credentials('ACCUKNOX_TOKEN')
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Install ASPM scanner') {
      steps {
        sh '''
          set -e
          python3 -m pip install --user \
            https://github.com/accuknox/aspm-scanner-cli/releases/download/v0.13.4/accuknox_aspm_scanner-0.13.4-py3-none-any.whl --break-system-packages
        '''
      }
    }


   stage('Run DAST Scan') {
      environment {
        SOFT_FAIL = "true"
        TARGET_URL = "https://juice-shop.herokuapp.com/"
        DAST_SCAN_SCRIPT = "zap-baseline.py"
      }
      steps {
        script {
          def softFailArg = (env.SOFT_FAIL == 'true') ? '--softfail' : ''
          sh '''
            mkdir -p /tmp/scan-dir
            chmod 777 /tmp/scan-dir
            cd /tmp/scan-dir
          '''
          def args = "${env.DAST_SCAN_SCRIPT} -t ${env.TARGET_URL} -I"
          def fullCmd = "~/.local/bin/accuknox-aspm-scanner scan ${softFailArg} dast --command \"${args}\" --container-mode"
          echo "Running: ${fullCmd}"
          sh fullCmd
          sh "cd -"
        }
      }
    }
  } 
}
